{"version":3,"file":"jsonConfig.js","sourceRoot":"","sources":["../../../../src/shim/configuration/jsonConfig.ts"],"names":[],"mappings":";;;AAAA,yBAAyB;AACzB,6BAA6B;AAC7B,wCAAoC;AAGpC,MAAM,sBAAsB,GAAG,wCAAwC,CAAC;AACxE,MAAM,WAAW,GAAG,2CAA2C,CAAC;AAEhE,MAAa,UAAU;IAanB;QACI,IAAI,CAAC,aAAa,EAAE,CAAC;IACzB,CAAC;IATM,MAAM,CAAC,WAAW;QACrB,IAAI,CAAC,UAAU,CAAC,SAAS,EAAE;YACvB,UAAU,CAAC,SAAS,GAAG,IAAI,UAAU,EAAE,CAAC;SAC3C;QACD,OAAO,UAAU,CAAC,SAAS,CAAC;IAChC,CAAC;IAMO,aAAa;QACjB,IAAI,UAAU,GAAG,EAAE,CAAC;QACpB,MAAM,iBAAiB,GAAG,OAAO,CAAC,GAAG,CAAC,WAAW,CAAC,CAAC;QACnD,6CAA6C;QAC7C,IAAI,iBAAiB,EAAE;YACnB,UAAU,GAAG,iBAAiB,CAAC;SAClC;QACD,YAAY;aACP;YACD,MAAM,cAAc,GAAG,0BAA0B,CAAC;YAClD,MAAM,QAAQ,GAAG,IAAI,CAAC,IAAI,CAAC,SAAS,EAAE,WAAW,CAAC,CAAC,CAAC,+CAA+C;YACnG,IAAI,OAAO,GAAG,IAAI,CAAC,IAAI,CAAC,QAAQ,EAAE,cAAc,CAAC,CAAC,CAAC,UAAU;YAC7D,MAAM,UAAU,GAAG,OAAO,CAAC,GAAG,CAAC,sBAAsB,CAAC,CAAC;YACvD,IAAI,UAAU,EAAE;gBACZ,IAAI,IAAI,CAAC,UAAU,CAAC,UAAU,CAAC,EAAE;oBAC7B,OAAO,GAAG,UAAU,CAAC;iBACxB;qBAAM;oBACH,OAAO,GAAG,IAAI,CAAC,IAAI,CAAC,QAAQ,EAAE,UAAU,CAAC,CAAC,CAAC,8CAA8C;iBAC5F;aACJ;YACD,IAAI;gBACA,UAAU,GAAG,EAAE,CAAC,YAAY,CAAC,OAAO,EAAE,MAAM,CAAC,CAAC;aACjD;YAAC,OAAO,GAAG,EAAE;gBACV,gBAAM,CAAC,WAAW,EAAE,CAAC,IAAI,CAAC,mCAAmC,EAAE,GAAG,CAAC,CAAC;aACvE;SACJ;QACD,IAAI;YACA,MAAM,UAAU,GAA+B,IAAI,CAAC,KAAK,CAAC,UAAU,CAAC,CAAC;YACtE,IAAI,CAAC,2BAA2B,GAAG,UAAU,CAAC,2BAA2B,CAAC;YAC1E,IAAI,CAAC,mBAAmB,GAAG,UAAU,CAAC,mBAAmB,CAAC;YAC1D,IAAI,CAAC,eAAe,GAAG,UAAU,CAAC,eAAe,CAAC;SACrD;QAAC,OAAO,GAAG,EAAE;YACV,gBAAM,CAAC,WAAW,EAAE,CAAC,IAAI,CAAC,uCAAuC,EAAE,GAAG,CAAC,CAAC;SAC3E;IACL,CAAC;CACJ;AApDD,gCAoDC","sourcesContent":["import * as fs from \"fs\";\r\nimport * as path from \"path\";\r\nimport { Logger } from \"../logging\";\r\nimport { ApplicationInsightsOptions, LogInstrumentationsConfig } from \"../../types\";\r\n\r\nconst ENV_CONFIGURATION_FILE = \"APPLICATIONINSIGHTS_CONFIGURATION_FILE\";\r\nconst ENV_CONTENT = \"APPLICATIONINSIGHTS_CONFIGURATION_CONTENT\";\r\n\r\nexport class JsonConfig implements ApplicationInsightsOptions {\r\n    private static _instance: JsonConfig;\r\n    public enableAutoCollectExceptions: boolean;\r\n    public logInstrumentations: LogInstrumentationsConfig;\r\n    public extendedMetrics: { [type: string]: boolean };\r\n\r\n    public static getInstance() {\r\n        if (!JsonConfig._instance) {\r\n            JsonConfig._instance = new JsonConfig();\r\n        }\r\n        return JsonConfig._instance;\r\n    }\r\n\r\n    constructor() {\r\n        this._loadJsonFile();\r\n    }\r\n\r\n    private _loadJsonFile() {\r\n        let jsonString = \"\";\r\n        const contentJsonConfig = process.env[ENV_CONTENT];\r\n        // JSON string added directly in env variable\r\n        if (contentJsonConfig) {\r\n            jsonString = contentJsonConfig;\r\n        }\r\n        // JSON file\r\n        else {\r\n            const configFileName = \"applicationinsights.json\";\r\n            const rootPath = path.join(__dirname, \"../../../\"); // Root of folder (__dirname = ../dist-esm/src)\r\n            let tempDir = path.join(rootPath, configFileName); // default\r\n            const configFile = process.env[ENV_CONFIGURATION_FILE];\r\n            if (configFile) {\r\n                if (path.isAbsolute(configFile)) {\r\n                    tempDir = configFile;\r\n                } else {\r\n                    tempDir = path.join(rootPath, configFile); // Relative path to applicationinsights folder\r\n                }\r\n            }\r\n            try {\r\n                jsonString = fs.readFileSync(tempDir, \"utf8\");\r\n            } catch (err) {\r\n                Logger.getInstance().info(\"Failed to read JSON config file: \", err);\r\n            }\r\n        }\r\n        try {\r\n            const jsonConfig: ApplicationInsightsOptions = JSON.parse(jsonString);\r\n            this.enableAutoCollectExceptions = jsonConfig.enableAutoCollectExceptions;\r\n            this.logInstrumentations = jsonConfig.logInstrumentations;\r\n            this.extendedMetrics = jsonConfig.extendedMetrics;\r\n        } catch (err) {\r\n            Logger.getInstance().info(\"Missing or invalid JSON config file: \", err);\r\n        }\r\n    }\r\n}\r\n"]}